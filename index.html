<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dusi Vua KM</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        /* Base Colors & Variables (Monochrome Theme) */
        :root {
            --primary-color: #333333; /* Dark Grey for text/accents */
            --secondary-color: #666666; /* Medium Grey for buttons/highlights */
            --background-color: #F8F8F8; /* Light Grey background */
            --text-color: #333333; /* Dark Grey text */
            --card-background: #FFFFFF; /* White for cards/containers */
            --border-color: #DDDDDD; /* Light border color */
            --border-radius: 15px; /* More rounded corners */
            --box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.6s;
            --transition-ease: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dark Theme (still monochrome but darker) */
        body.dark-theme {
            --primary-color: #BBBBBB;
            --secondary-color: #999999;
            --background-color: #1A1A1A;
            --text-color: #F0F0F0;
            --card-background: #2C2C2C;
            --border-color: #444444;
            --box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        /* Cute Theme (example - using some pastels) */
        body.cute-theme {
            --primary-color: #FF69B4; /* Hot Pink */
            --secondary-color: #87CEEB; /* Sky Blue */
            --background-color: #FFF0F5; /* Lavender Blush */
            --text-color: #4B0082; /* Indigo */
            --card-background: #FFFFFF;
            --border-color: #F0A0D0;
            --box-shadow: 0 8px 20px rgba(255, 105, 180, 0.2);
        }

        body {
            font-family: 'Montserrat', sans-serif; /* Default text font */
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-y: auto; /* Allow scrolling if content overflows */
            transition: background-color var(--transition-speed) var(--transition-ease),
                        color var(--transition-speed) var(--transition-ease);
        }

        /* Intro Section */
        #intro-section {
            background-color: var(--card-background);
            padding: 45px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            max-width: 650px;
            width: 90%;
            display: flex; /* Use flex for centering content easily */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 300px; /* Make intro box a bit taller */
            transition: opacity 0.7s var(--transition-ease),
                        transform 0.7s var(--transition-ease),
                        background-color var(--transition-speed) var(--transition-ease),
                        color var(--transition-speed) var(--transition-ease);
            z-index: 2; /* Ensure it's above stars */
            position: relative; /* For z-index to work */
        }

        #intro-section.hidden {
            opacity: 0;
            transform: translateY(-50px); /* Move up slightly when hidden */
            pointer-events: none; /* Disable interaction */
        }

        #intro-section h1 {
            color: var(--primary-color);
            margin-bottom: 35px;
            font-family: 'Pacifico', cursive; /* Cute font for main title */
            font-size: 3em;
            transition: color var(--transition-speed) var(--transition-ease);
        }

        #intro-section p {
            font-size: 1.2em;
            color: var(--text-color);
            line-height: 1.6;
            margin-bottom: 30px;
        }

        #go-button {
            background-color: var(--secondary-color);
            color: white;
            padding: 18px 40px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1.5em;
            font-weight: 700;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        #go-button:hover {
            background-color: color-mix(in srgb, var(--secondary-color) 85%, black);
            transform: translateY(-5px);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.2);
        }

        /* Main Content - Hidden by default */
        #main-content {
            background-color: var(--card-background);
            padding: 45px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            max-width: 650px;
            width: 90%;
            opacity: 0; /* Hidden by default */
            transform: translateY(50px); /* Start from below */
            position: relative; /* Needed for theme selector positioning */
            transition: opacity 0.7s var(--transition-ease),
                        transform 0.7s var(--transition-ease),
                        background-color var(--transition-speed) var(--transition-ease),
                        color var(--transition-speed) var(--transition-ease),
                        box-shadow var(--transition-speed) var(--transition-ease);
            pointer-events: none; /* Disable interaction when hidden */
            z-index: 2; /* Ensure it's above stars */
        }
        
        #main-content.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all; /* Enable interaction when visible */
        }

        /* Theme Selector button (top right) */
        #theme-select-btn-top {
            position: absolute;
            top: 20px; /* Distance from top */
            right: 20px; /* Distance from right */
            background-color: var(--primary-color); /* Use primary color for settings icon */
            color: white;
            border: none;
            border-radius: 50%; /* Make it round */
            width: 50px; /* Icon size */
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9em; /* Smaller font for "Settings" or icon */
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            z-index: 10; /* Ensure it's above other elements */
            text-align: center;
            text-decoration: none; /* In case it's an anchor tag */
            line-height: 1; /* For vertical alignment of text */
        }

        #theme-select-btn-top:hover {
            background-color: color-mix(in srgb, var(--primary-color) 80%, black);
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        #theme-select-btn-top:active {
            transform: scale(0.98);
        }
        
        /* J97 Music Button (top left) */
        #j97-music-btn-main {
            position: absolute;
            top: 20px; /* Distance from top */
            left: 20px; /* Distance from left */
            background-color: #A0522D; /* Sienna - màu đất */
            color: white;
            border: none;
            border-radius: 50%; /* Make it round */
            width: 50px; /* Icon size */
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9em; /* Smaller font for "J97" */
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            z-index: 10; /* Ensure it's above other elements */
            text-align: center;
            text-decoration: none; /* In case it's an anchor tag */
            line-height: 1; /* For vertical alignment of text */
        }

        #j97-music-btn-main:hover {
            background-color: color-mix(in srgb, #A0522D 85%, black);
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        #j97-music-btn-main:active {
            transform: scale(0.98);
        }

        /* Music Options (J97) Popup */
        #j97-music-popup {
            position: absolute;
            top: 80px; /* Below J97 button */
            left: 20px;
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px;
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 10px;
            z-index: 11; /* Above J97 button and main content */
            min-width: 150px;
            text-align: center;
        }

        #j97-music-popup.visible {
            display: flex;
        }

        .music-option {
            background-color: var(--secondary-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 10px; /* Rounded corners for buttons in popup */
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        .music-option:hover {
            background-color: color-mix(in srgb, var(--secondary-color) 85%, black);
            transform: translateY(-2px);
        }
        .music-option.selected {
            background-color: var(--primary-color); /* Highlight selected song */
            border: 2px solid white;
            transform: scale(1.05);
        }


        .main-title { /* Used for both intro and main content H1 */
            color: var(--primary-color);
            margin-bottom: 35px;
            font-family: 'Pacifico', cursive; /* Cute font for main title */
            font-size: 3em;
            transition: color var(--transition-speed) var(--transition-ease);
        }

        .menu-item {
            background-color: var(--secondary-color);
            color: white;
            padding: 20px 30px;
            margin: 18px 0;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            font-size: 1.3em;
            font-weight: 700;
            border: none;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
            text-align: left;
            padding-left: 40px;
            letter-spacing: 0.5px;
        }

        .menu-item:hover {
            background-color: color-mix(in srgb, var(--secondary-color) 85%, black);
            transform: translateY(-7px); /* More pronounced lift */
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
        }

        .menu-item:active {
            transform: translateY(0);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .menu-item.disabled {
            background-color: #CCCCCC; /* Lighter grey for disabled */
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        .menu-item.disabled:hover {
            background-color: #CCCCCC;
            transform: none;
            box-shadow: none;
        }

        /* Calculator Section */
        #calculator-section {
            background-color: var(--card-background);
            padding: 35px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-top: 35px;
            text-align: left;
            display: none; /* Hidden by default, shown by JS */
            animation: fadeInFromTop 0.7s var(--transition-ease) forwards;
            transition: background-color var(--transition-speed) var(--transition-ease),
                        color var(--transition-speed) var(--transition-ease),
                        box-shadow var(--transition-speed) var(--transition-ease);
        }

        @keyframes fadeInFromTop {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #calculator-section h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-family: 'Pacifico', cursive; /* Cute font for section title */
            font-size: 2.5em;
            transition: color var(--transition-speed) var(--transition-ease);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 25px;
        }

        .input-group label {
            margin-bottom: 10px;
            font-weight: 700;
            color: var(--text-color);
            font-size: 1.1em;
        }

        .input-group input[type="number"] {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1.2em;
            width: calc(100% - 30px);
            box-sizing: border-box;
            color: var(--text-color);
            background-color: var(--card-background);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color var(--transition-speed) var(--transition-ease);
        }

        .input-group input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 5px rgba(0, 0, 0, 0.1);
        }

        button.calculate-btn {
            background-color: var(--secondary-color);
            color: white;
            padding: 18px 30px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1.3em;
            font-weight: 700;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            box-sizing: border-box;
            margin-top: 30px;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        button.calculate-btn:hover {
            background-color: color-mix(in srgb, var(--secondary-color) 85%, black);
            transform: translateY(-5px);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.2);
        }

        #result {
            margin-top: 35px;
            padding: 25px;
            background-color: color-mix(in srgb, var(--primary-color) 10%, var(--card-background));
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            display: none;
            word-wrap: break-word;
            transition: background-color var(--transition-speed) var(--transition-ease),
                        color var(--transition-speed) var(--transition-ease),
                        border-color var(--transition-speed) var(--transition-ease);
        }

        /* Theme Selector Section */
        #theme-section {
            background-color: var(--card-background);
            padding: 35px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-top: 35px;
            text-align: center;
            display: none; /* Hidden by default, shown by JS */
            animation: fadeInFromTop 0.7s var(--transition-ease) forwards;
            transition: background-color var(--transition-speed) var(--transition-ease),
                        color var(--transition-speed) var(--transition-ease),
                        box-shadow var(--transition-speed) var(--transition-ease);
        }

        #theme-section h2 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-family: 'Pacifico', cursive;
            font-size: 2.5em;
            transition: color var(--transition-speed) var(--transition-ease);
        }

        .theme-options {
            display: flex;
            justify-content: center;
            gap: 25px;
            flex-wrap: wrap;
            margin-bottom: 30px; /* Khoảng cách dưới các lựa chọn theme */
        }

        .theme-option {
            width: 100px; /* Larger circles */
            height: 100px;
            border-radius: 50%;
            cursor: pointer;
            border: 5px solid transparent; /* Thicker border for selected */
            transition: border-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 700;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.4);
            font-size: 1em;
            font-family: 'Montserrat', sans-serif;
        }

        .theme-option.default-theme { background-color: #666666; } /* Secondary color of monochrome */
        .theme-option.dark-theme { background-color: #2C2C2C; } /* Card background of dark monochrome */
        .theme-option.cute-theme { background-color: #FF69B4; } /* Hot pink for cute theme */

        .theme-option:hover {
            transform: translateY(-8px); /* More lift */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
        }

        .theme-option.selected {
            border-color: var(--secondary-color); /* Highlight with secondary color */
            transform: scale(1.15); /* More pronounced scale */
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.3);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #intro-section, #main-content {
                padding: 30px;
            }
            #intro-section h1, .main-title {
                font-size: 2.2em;
            }
            .menu-item {
                padding: 15px 20px;
                font-size: 1.1em;
            }
            .input-group input[type="number"], button.calculate-btn {
                font-size: 1.1em;
                padding: 12px;
            }
            .theme-option {
                width: 80px;
                height: 80px;
            }
            #theme-select-btn-top, #j97-music-btn-main {
                width: 40px;
                height: 40px;
                font-size: 0.8em;
                top: 15px;
                right: 15px; /* For theme button */
                left: 15px; /* For J97 button */
            }
            #j97-music-popup {
                top: 70px;
                left: 15px;
            }
        }

        @media (max-width: 480px) {
            #intro-section, #main-content {
                padding: 20px;
                margin: 20px;
            }
            #intro-section h1, .main-title {
                font-size: 1.8em;
            }
            #intro-section p {
                font-size: 1em;
            }
            #go-button {
                font-size: 1.2em;
                padding: 15px 30px;
            }
            .menu-item {
                font-size: 1em;
                padding-left: 20px;
                margin: 10px 0;
            }
            #calculator-section h2, #theme-section h2 {
                font-size: 2em;
            }
            .input-group label {
                font-size: 1em;
            }
            .theme-options {
                gap: 15px;
            }
            .theme-option {
                width: 70px;
                height: 70px;
                font-size: 0.8em;
            }
            #theme-select-btn-top, #j97-music-btn-main {
                width: 35px;
                height: 35px;
                font-size: 0.7em;
                top: 10px;
                right: 10px; /* For theme button */
                left: 10px; /* For J97 button */
            }
            #j97-music-popup {
                top: 60px;
                left: 10px;
                min-width: 120px;
            }
        }

        /* Youtube Player (hidden) */
        #youtube-player-container {
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: -1;
            width: 1px;
            height: 1px;
            overflow: hidden;
            opacity: 0;
            pointer-events: none;
        }

        /* Starfall Effect */
        .star {
            position: fixed;
            background-color: white;
            border-radius: 50%;
            animation: fall linear infinite;
            z-index: 1; /* Under main content */
            opacity: 0; /* Hidden until main content is visible */
        }

        @keyframes fall {
            from {
                transform: translateY(-100vh) translateX(0);
                opacity: 0;
            }
            to {
                transform: translateY(100vh) translateX(var(--star-drift));
                opacity: 1;
            }
        }
    </style>
</head>
<body>

    <div id="intro-section">
        <h1 class="main-title">Chào mừng đến với Dusi Vua KM</h1>
        <p>Đây là trang web hỗ trợ bạn trong việc tính toán và tối ưu hóa các chiến lược nhỏ.</p>
        <button id="go-button">GO</button>
    </div>

    <div id="main-content">
        <button id="theme-select-btn-top">Giao diện</button>
        <button id="j97-music-btn-main">J97</button>
        
        <div id="j97-music-popup">
            <button class="music-option" data-video-id="r5Lq2Y1K220">Hồng Nhan</button>
            <button class="music-option" data-video-id="E80e9D51L3Y">Bạc Phận</button>
            <button class="music-option" data-video-id="G9bM-dGqQeM">Sống Chó</button>
            <button class="music-option" id="stop-music-btn">Dừng nhạc</button>
        </div>

        <h1 class="main-title">Chào mừng đến với Dusi Vua KM</h1>
        <button class="menu-item" id="bot-calculate-btn">1. BOT tính ít lỗ nhất</button>
        <button class="menu-item disabled">2. Update...</button>
        <button class="menu-item disabled">3. Update...</button>

        <div id="calculator-section">
            <h2>BOT tính ít lỗ nhất</h2>
            <div class="input-group">
                <label for="cua-tien">Số tiền bên Cái ($):</label>
                <input type="number" id="cua-tien" placeholder="Nhập số tiền bên Cái">
            </div>
            <div class="input-group">
                <label for="con-tien">Số tiền bên Con ($):</label>
                <input type="number" id="con-tien" placeholder="Nhập số tiền bên Con">
            </div>
            <button class="calculate-btn" id="calculate-loss-btn">Tính toán</button>
            <div id="result"></div>
        </div>

        <div id="theme-section">
            <h2>Chọn giao diện</h2>
            <div class="theme-options">
                <div class="theme-option default-theme selected" data-theme="default">Tối giản</div>
                <div class="theme-option dark-theme" data-theme="dark">Tối</div>
                <div class="theme-option cute-theme" data-theme="cute">Dễ thương</div>
            </div>
        </div>
    </div>

    <div id="youtube-player-container">
        <div id="youtube-player"></div>
    </div>

    <script>
        // --- YouTube IFrame Player API Load ---
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/watch?v=dQw4w9WgXcQ"; // YouTube API URL
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // --- Global Variables for YouTube Player ---
        let player;
        let currentPlayingVideoId = null;
        let isPlayerReady = false;

        // --- YouTube API Functions ---
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-player', {
                height: '0', // Hidden
                width: '0',  // Hidden
                videoId: null, // No video initially
                playerVars: {
                    'autoplay': 1, // Will be blocked by browsers, but API needs it
                    'controls': 0, // Hide controls
                    'loop': 1,      // Loop single video by setting playlist to itself
                    'playlist': '', // Will be set dynamically
                    'disablekb': 1, // Disable keyboard controls
                    'fs': 0,        // Disable fullscreen button
                    'modestbranding': 1, // Minimize YouTube branding
                    'mute': 0,      // Not muted by default (user can mute if needed)
                    'playsinline': 1, // Play inline on mobile
                    'enablejsapi': 1 // Enable JS control
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            console.log("YouTube Player is Ready.");
            isPlayerReady = true;
            // No automatic play here, waits for user interaction on J97 button
        }

        function onPlayerStateChange(event) {
            // Check if video ended (state = 0) AND there's a video playing
            if (event.data === YT.PlayerState.ENDED && currentPlayingVideoId) {
                // If the video ended, play it again to loop
                player.loadVideoById({
                    videoId: currentPlayingVideoId,
                    startSeconds: 0 // Start from the beginning
                });
                player.playVideo(); // Ensure it plays again
            }
        }

        // Function to play a specific YouTube video
        function playYoutubeVideo(videoId) {
            if (!isPlayerReady) {
                console.warn("YouTube Player not ready yet. Please try again.");
                return;
            }
            if (currentPlayingVideoId === videoId) {
                // If the same video is already playing, do nothing
                if (player.getPlayerState() !== YT.PlayerState.PLAYING) {
                    player.playVideo().catch(e => console.error("Error resuming video:", e));
                }
                return;
            }

            currentPlayingVideoId = videoId; // Update currently playing video ID
            player.loadVideoById({
                videoId: videoId,
                // To loop a single video, playlist parameter must contain the videoId itself
                'playlist': videoId,
                startSeconds: 0 // Start from the beginning
            });
            player.playVideo().catch(e => {
                console.error("Lỗi khi phát video:", e);
                // Inform user if autoplay is blocked
                alert("Trình duyệt có thể chặn tự động phát. Vui lòng tương tác (ví dụ: click vào trang) để bật nhạc.");
            });
        }

        // Function to stop music
        function stopYoutubeVideo() {
            if (player && player.getPlayerState() !== YT.PlayerState.ENDED) {
                player.stopVideo();
                currentPlayingVideoId = null;
                // Remove 'selected' class from all music options
                document.querySelectorAll('.music-option').forEach(btn => btn.classList.remove('selected'));
            }
        }

        // --- Starfall Effect ---
        function createStar() {
            const star = document.createElement('div');
            star.classList.add('star');
            document.body.appendChild(star);

            const size = Math.random() * 3 + 1; // 1px to 4px
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            star.style.left = `${Math.random() * 100}vw`; // Random horizontal position
            star.style.animationDuration = `${Math.random() * 5 + 5}s`; // 5s to 10s
            star.style.animationDelay = `${Math.random() * 0}s`; // Delay for staggered start
            star.style.setProperty('--star-drift', `${(Math.random() - 0.5) * 200}px`); // Drift left/right
            star.style.opacity = `${Math.random() * 0.7 + 0.3}`; // Random opacity

            star.addEventListener('animationend', () => {
                star.remove(); // Remove star after animation ends
            });
        }

        let starInterval;
        function startStarfall() {
            // Only start if intro is hidden and main content is visible
            if (!document.getElementById('intro-section').classList.contains('hidden') && 
                document.getElementById('main-content').classList.contains('visible')) {
                // To avoid duplicate intervals
                if (starInterval) clearInterval(starInterval); 
                starInterval = setInterval(createStar, 200); // Create a star every 200ms
            } else if (document.getElementById('intro-section').classList.contains('hidden') && 
                       document.getElementById('main-content').classList.contains('visible') && !starInterval) {
                 starInterval = setInterval(createStar, 200);
            }
        }

        function stopStarfall() {
            clearInterval(starInterval);
            starInterval = null;
            document.querySelectorAll('.star').forEach(star => star.remove()); // Remove all existing stars
        }


        // --- DOMContentLoaded Event Listener ---
        document.addEventListener('DOMContentLoaded', () => {
            const introSection = document.getElementById('intro-section');
            const goButton = document.getElementById('go-button');
            const mainContent = document.getElementById('main-content');
            const botCalculateBtn = document.getElementById('bot-calculate-btn');
            const themeSelectBtnTop = document.getElementById('theme-select-btn-top');
            const calculatorSection = document.getElementById('calculator-section');
            const themeSection = document.getElementById('theme-section');
            const cuaTienInput = document.getElementById('cua-tien');
            const conTienInput = document.getElementById('con-tien');
            const calculateLossBtn = document.getElementById('calculate-loss-btn');
            const resultDiv = document.getElementById('result');
            const themeOptions = document.querySelectorAll('.theme-option');

            // Music Buttons
            const j97MusicBtnMain = document.getElementById('j97-music-btn-main');
            const j97MusicPopup = document.getElementById('j97-music-popup');
            const musicOptions = document.querySelectorAll('#j97-music-popup .music-option');
            const stopMusicBtn = document.getElementById('stop-music-btn');

            // Load saved theme on page load
            const savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme && savedTheme !== 'default') {
                document.body.classList.add(`${savedTheme}-theme`);
                themeOptions.forEach(option => {
                    if (option.dataset.theme === savedTheme) {
                        option.classList.add('selected');
                    } else {
                        option.classList.remove('selected');
                    }
                });
            }

            // --- Intro and Main Content Visibility ---
            goButton.addEventListener('click', () => {
                introSection.classList.add('hidden'); // Hide intro
                // Use a timeout to ensure transition finishes before changing display
                setTimeout(() => {
                    introSection.style.display = 'none';
                    mainContent.style.display = 'block'; // Make main content block
                    mainContent.classList.add('visible'); // Show main content with animation
                    startStarfall(); // Start starfall when main content is visible
                }, 700); // Match CSS transition duration
            });

            // --- Navigation Function ---
            function showSection(sectionToShow) {
                calculatorSection.style.display = 'none';
                themeSection.style.display = 'none';
                resultDiv.style.display = 'none';
                j97MusicPopup.classList.remove('visible'); // Hide music popup when changing section

                if (sectionToShow) {
                    sectionToShow.style.display = 'block';
                    // Optional: scroll to the top of the new section
                    sectionToShow.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            // --- Menu Button Event Listeners ---
            botCalculateBtn.addEventListener('click', () => {
                showSection(calculatorSection);
                cuaTienInput.value = '';
                conTienInput.value = '';
            });

            themeSelectBtnTop.addEventListener('click', () => {
                showSection(themeSection);
            });

            // --- J97 Music Button Logic ---
            j97MusicBtnMain.addEventListener('click', (event) => {
                // Toggle visibility of the music popup
                j97MusicPopup.classList.toggle('visible');
                event.stopPropagation(); // Prevent click from bubbling to document.body
            });

            // Hide music popup when clicking anywhere else on the document
            document.body.addEventListener('click', (event) => {
                if (j97MusicPopup.classList.contains('visible') && !j97MusicPopup.contains(event.target) && event.target !== j97MusicBtnMain) {
                    j97MusicPopup.classList.remove('visible');
                }
            });

            // Event listeners for individual music options
            musicOptions.forEach(button => {
                button.addEventListener('click', () => {
                    const videoId = button.dataset.videoId;
                    // Remove 'selected' from all and add to clicked button
                    musicOptions.forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    
                    playYoutubeVideo(videoId); // Play selected music
                });
            });

            // Event listener for Stop Music button
            stopMusicBtn.addEventListener('click', () => {
                stopYoutubeVideo();
            });

            // --- Initial Music Play on First User Interaction ---
            let hasUserInteractedForMusic = false;
            // This event is crucial for overcoming browser autoplay restrictions
            document.body.addEventListener('click', () => {
                if (!hasUserInteractedForMusic && isPlayerReady && currentPlayingVideoId) {
                    // Only try to play if a video ID is set (from a previous selection)
                    player.playVideo().catch(e => {
                        console.warn("Lỗi khi phát video sau tương tác ban đầu:", e);
                    });
                    hasUserInteractedForMusic = true; // Flag to prevent re-execution
                }
            }, { once: true }); // Only listen for the first click

            // --- Calculator Logic ---
            calculateLossBtn.addEventListener('click', () => {
                const cuaTien = parseFloat(cuaTienInput.value);
                const conTien = parseFloat(conTienInput.value);
                const tyLeCai = 0.95; // Tỷ lệ ăn Cái (0.95 cho mỗi 1 đơn vị đặt)

                let resultText = '';
                let isCalculationPossible = false;

                if (!isNaN(cuaTien) && isNaN(conTien)) {
                    // Chỉ nhập tiền Cái
                    const tienConToBet = (cuaTien * (1 + tyLeCai)) / 2;
                    resultText = `Con đánh ${tienConToBet.toLocaleString('vi-VN', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}`;
                    isCalculationPossible = true;
                } else if (isNaN(cuaTien) && !isNaN(conTien)) {
                    // Chỉ nhập tiền Con
                    const tienCaiToBet = (2 * conTien) / (1 + tyLeCai);
                    resultText = `Cái đánh ${tienCaiToBet.toLocaleString('vi-VN', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}`;
                    isCalculationPossible = true;
                } else if (!isNaN(cuaTien) && !isNaN(conTien)) {
                    // Nhập cả hai
                    resultText = 'Vui lòng chỉ nhập số tiền vào **MỘT** trong hai ô (Con hoặc Cái) để tính toán.';
                } else {
                    // Không nhập gì cả
                    resultText = 'Vui lòng nhập số tiền để tính toán.';
                }

                if (isCalculationPossible) {
                    resultText += ', Chúc bạn may mắn!';
                }
                
                resultDiv.innerHTML = resultText;
                resultDiv.style.display = 'block';
            });

            // Auto-clear other input when one is typed into
            cuaTienInput.addEventListener('input', () => {
                if (cuaTienInput.value !== '') {
                    conTienInput.value = '';
                }
            });

            conTienInput.addEventListener('input', () => {
                if (conTienInput.value !== '') {
                    cuaTienInput.value = '';
                }
            });

            // --- Theme Selection Logic ---
            themeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    themeOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');

                    const theme = option.dataset.theme;
                    document.body.className = '';
                    if (theme !== 'default') {
                        document.body.classList.add(`${theme}-theme`);
                    }
                    localStorage.setItem('selectedTheme', theme);
                });
            });
        });
    </script>
</body>
</html>
